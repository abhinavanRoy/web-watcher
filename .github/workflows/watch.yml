name: Watch APIS current social events

on:
  schedule:
    - cron: "*/6 * * * *"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  watch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Restore state cache
        uses: actions/cache@v4
        with:
          path: .state
          key: apis-state-v1
          restore-keys: apis-state-v1

      - name: Check page
        id: check
        run: python watcher.py

      # Simple push notification via ntfy.sh
      - name: Notify via ntfy
        if: steps.check.outputs.changed == 'true'
        run: |
          curl -s \
            -H "Title: APIS social events changed" \
            -d "Detected a change in 'Current social events'. Open: ${{ steps.check.outputs.url }}" \
            "https://ntfy.sh/${{ secrets.NTFY_TOPIC }}"

      # Optional: create a GitHub issue (you'll get GitHub notifications)
      - name: Create GitHub Issue
        if: steps.check.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `APIS social events changed (${new Date().toISOString()})`;
            const body = [
              `URL: ${{ steps.check.outputs.url }}`,
              ``,
              `New content:`,
              `${{ steps.check.outputs.content }}`
            ].join('\n');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body
            });
